apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: petclinic
  labels:
    app: frontend
data:
  application.yml: |
    server:
      port: 8080
      compression:
        enabled: true
        mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css

    spring:
      application:
        name: frontend
      config:
        import: optional:configserver:${CONFIG_SERVER_URL:http://config-server:8888}
      cloud:
        gateway:
          # フロントエンド専用設定: バックエンドAPIルーティングは全てKong Gatewayに転送
          # Note: /api/gateway/** routes from Angular SPA
          routes:
            # /owners/** -> /api/customer/owners/** (for Angular SPA compatibility)
            - id: gateway-owners
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/owners/**
              filters:
                - RewritePath=/owners/(?<segment>.*), /api/customer/owners/$\{segment}
            
            # /petTypes -> /api/customer/petTypes
            - id: gateway-pettypes
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/petTypes
              filters:
                - SetPath=/api/customer/petTypes
            
            # /pets/** -> /api/customer/pets/**
            - id: gateway-pets
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/pets/**
              filters:
                - RewritePath=/pets/(?<segment>.*), /api/customer/pets/$\{segment}
            
            # /visits/** -> /api/visit/visits/**
            - id: gateway-visits
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/visits/**
              filters:
                - RewritePath=/visits/(?<segment>.*), /api/visit/visits/$\{segment}
            
            # /vets -> /api/vet/vets
            - id: gateway-vets
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/vets
              filters:
                - SetPath=/api/vet/vets
            
            # Customers API - Kong経由
            - id: customers-service
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/api/customer/**
              filters:
                - StripPrefix=0
            
            # Visits API - Kong経由
            - id: visits-service
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/api/visit/**
              filters:
                - StripPrefix=0
            
            # Vets API - Kong経由
            - id: vets-service
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/api/vet/**
              filters:
                - StripPrefix=0
            
            # GenAI API (Java) - Kong経由
            - id: genai-service
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/api/genai/**
              filters:
                - StripPrefix=0
            
            # GenAI Python API - Kong経由
            - id: genai-python
              uri: http://kong-gateway-proxy.kong.svc.cluster.local:8000
              predicates:
                - Path=/api/genai-python/**
              filters:
                - StripPrefix=0
        discovery:
          enabled: false

    eureka:
      client:
        enabled: true
        serviceUrl:
          defaultZone: ${EUREKA_SERVER_URL:http://discovery-server:8761/eureka}
        registryFetchIntervalSeconds: 5
        registerWithEureka: true
        fetchRegistry: true
      instance:
        preferIpAddress: true
        lease-renewal-interval-in-seconds: 5

    management:
      endpoints:
        web:
          exposure:
            include: '*'
      endpoint:
        health:
          show-details: always
      # Disable Spring Boot's built-in tracing (using OpenTelemetry instead)
      tracing:
        enabled: false
      zipkin:
        tracing:
          endpoint: ""  # Disable Zipkin exporter
      
    # Disable Spring Cloud Sleuth Zipkin (OpenTelemetry handles all tracing)
    # This prevents duplicate traces to localhost:9411
    spring.zipkin.enabled: false
    spring.sleuth.enabled: false

    logging:
      level:
        root: INFO
        org.springframework.cloud.gateway: INFO
        org.springframework.web: INFO

